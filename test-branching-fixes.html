<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Branching Fixes Test</title>
    <style>
        .hidden-step { display: none !important; }
        .error-field { border: 2px solid red; }
        .active-step { border: 2px solid green; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        .test-results { background: #f0f0f0; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Branching Fixes Test</h1>
    
    <div class="test-section">
        <h2>Test: State Sync & Required Field Management</h2>
        
        <form data-form="multistep" data-logic="true">
            <!-- Step 1: User Type Selection -->
            <div data-form="step" data-answer="step-1">
                <h3>Step 1: Select User Type</h3>
                <label>
                    <input type="radio" name="userType" value="personal" data-step-field-name="userType" data-go-to="personal-step">
                    Personal
                </label>
                <label>
                    <input type="radio" name="userType" value="business" data-step-field-name="userType" data-go-to="business-step">
                    Business
                </label>
            </div>
            
            <!-- Step 2: Personal Details (conditional) -->
            <div data-form="step" data-answer="personal-step" data-show-if="personal-step">
                <h3>Step 2: Personal Details</h3>
                <input type="text" name="personalName" data-step-field-name="personalName" placeholder="Your Name" required>
                <input type="email" name="personalEmail" data-step-field-name="personalEmail" placeholder="Email" required>
            </div>
            
            <!-- Step 3: Business Details (conditional) -->
            <div data-form="step" data-answer="business-step" data-show-if="business-step">
                <h3>Step 3: Business Details</h3>
                <input type="text" name="companyName" data-step-field-name="companyName" placeholder="Company Name" required>
                <input type="text" name="businessEmail" data-step-field-name="businessEmail" placeholder="Business Email" required>
            </div>
            
            <!-- Navigation -->
            <div>
                <button type="button" data-form="back-btn">Back</button>
                <button type="button" data-form="next-btn">Next</button>
                <button type="button" data-form="submit">Submit</button>
            </div>
        </form>
    </div>
    
    <div class="test-results">
        <h3>Test Results</h3>
        <div id="test-output"></div>
        <button onclick="runTests()">Run Tests</button>
        <button onclick="logCurrentState()">Log Current State</button>
    </div>

    <script type="module">
        import FormLib from './dist/index.js';
        
        window.FormLib = FormLib;
        
        // Initialize the library
        FormLib.init();
        
        window.runTests = function() {
            const output = document.getElementById('test-output');
            const results = [];
            
            // Test 1: Check initial state
            const initialState = FormLib.getState();
            results.push(`✓ Initial state loaded: ${initialState.initialized}`);
            
            // Test 2: Select personal option
            const personalRadio = document.querySelector('input[value="personal"]');
            personalRadio.checked = true;
            personalRadio.dispatchEvent(new Event('change', { bubbles: true }));
            
            setTimeout(() => {
                // Check if personal step is visible in both DOM and FormState
                const personalStep = document.querySelector('[data-answer="personal-step"]');
                const personalStepVisible = !personalStep.classList.contains('hidden-step');
                const formStateVisible = FormLib.getState().formState.steps['personal-step']?.visible;
                
                results.push(`✓ Personal step DOM visible: ${personalStepVisible}`);
                results.push(`✓ Personal step FormState visible: ${formStateVisible}`);
                results.push(`✓ State sync working: ${personalStepVisible === formStateVisible}`);
                
                // Check required fields
                const personalNameField = document.querySelector('[name="personalName"]');
                const businessNameField = document.querySelector('[name="companyName"]');
                
                results.push(`✓ Personal name field required: ${personalNameField.required}`);
                results.push(`✓ Business name field required: ${businessNameField.required}`);
                
                // Test 3: Switch to business
                const businessRadio = document.querySelector('input[value="business"]');
                businessRadio.checked = true;
                businessRadio.dispatchEvent(new Event('change', { bubbles: true }));
                
                setTimeout(() => {
                    const businessStep = document.querySelector('[data-answer="business-step"]');
                    const businessStepVisible = !businessStep.classList.contains('hidden-step');
                    const businessFormStateVisible = FormLib.getState().formState.steps['business-step']?.visible;
                    const personalFormStateVisible = FormLib.getState().formState.steps['personal-step']?.visible;
                    
                    results.push(`✓ Business step DOM visible: ${businessStepVisible}`);
                    results.push(`✓ Business step FormState visible: ${businessFormStateVisible}`);
                    results.push(`✓ Personal step FormState hidden: ${!personalFormStateVisible}`);
                    
                    // Check required fields switched
                    results.push(`✓ Personal name field no longer required: ${!personalNameField.required}`);
                    results.push(`✓ Business name field now required: ${businessNameField.required}`);
                    
                    output.innerHTML = results.join('<br>');
                }, 100);
            }, 100);
        };
        
        window.logCurrentState = function() {
            console.log('Current FormLib State:', FormLib.getState());
        };
    </script>
</body>
</html> 