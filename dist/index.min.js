/*!
 * Form Functionality Library v1.1.0
 * Browser-compatible bundle
 */
!function(e){"use strict";const t='[data-form="multistep"]',i="[data-logic]",n='[data-form="step"]',a="[data-answer]",s='[data-form="next-btn"]',r='[data-form="back-btn"]',o='[data-form="submit"]',l="[data-skip]",d="[data-go-to]",c="[data-step-field-name]",u="[data-summary-field]",p={START_STEP:1,DEBUG:!0,LOG_PREFIX:"[FormLib]",VALIDATION_DELAY:300,ANIMATION_DURATION:300,JOIN_SEPARATOR:{space:" ",comma:", ",dash:" - ",pipe:" | ",newline:"\n"}},m="active-step",f="hidden-step-item",h="error-field",g="error-message",y="disabled";function b(e,t){if(!p.DEBUG)return;const i=(new Date).toISOString().split("T")[1].split(".")[0],n=`${p.LOG_PREFIX} [${i}]`;void 0!==t?console.log(`${n} ${e}`,t):console.log(`${n} ${e}`)}function v(e,t=document){return t.querySelectorAll(e)}function S(e,t=document){return t.querySelector(e)}function $(e,t){return e.getAttribute(t)}function F(e,t){e.classList.add(t)}function A(e,t){e.classList.remove(t)}function I(e){return"none"!==e.style.display&&!function(e,t){return e.classList.contains(t)}(e,"hidden-step")}function E(e){return e instanceof HTMLInputElement||e instanceof HTMLSelectElement||e instanceof HTMLTextAreaElement}function L(e){return e instanceof HTMLInputElement?"checkbox"===e.type||"radio"===e.type?e.checked?e.value:"":e.value:e instanceof HTMLSelectElement&&e.multiple?Array.from(e.selectedOptions).map(e=>e.value):e.value}function w(e,t,i,n){const a=e=>{const t=e.target?.closest(i);t&&n(e,t)};return e.addEventListener(t,a),()=>{e.removeEventListener(t,a)}}class x{constructor(){this.data={},this.steps={},this.branchPath={currentStep:"",previousSteps:[],skippedSteps:[],activeConditions:{}},b("FormState initialized")}static getInstance(){return x.instance||(x.instance=new x),x.instance}setField(e,t){const i=this.data[e];this.data[e]=t,b(`Field updated: ${e}`,{oldValue:i,newValue:t}),this.onFieldChange(e,t,i)}getField(e){return this.data[e]}getAll(){return{...this.data}}clear(){const e={...this.data};this.data={},this.steps={},this.branchPath={currentStep:"",previousSteps:[],skippedSteps:[],activeConditions:{}},b("FormState cleared",{oldData:e})}clearFields(e){const t={};e.forEach(e=>{void 0!==this.data[e]&&(t[e]=this.data[e],delete this.data[e])}),Object.keys(t).length>0&&b("Fields cleared due to branch change",t)}setStepInfo(e,t){this.steps[e]||(this.steps[e]={visible:!1,visited:!1}),Object.assign(this.steps[e],t),b(`Step info updated: ${e}`,this.steps[e])}getStepInfo(e){return this.steps[e]}getAllSteps(){return{...this.steps}}setStepVisibility(e,t){this.setStepInfo(e,{visible:t}),b(`Step visibility updated: ${e}`,{visible:t})}setCurrentStep(e){this.branchPath.currentStep&&this.branchPath.currentStep!==e&&this.branchPath.previousSteps.push(this.branchPath.currentStep),this.branchPath.currentStep=e,this.setStepInfo(e,{visited:!0}),b(`Current step changed to: ${e}`,this.branchPath)}getCurrentStep(){return this.branchPath.currentStep}getBranchPath(){return{...this.branchPath}}addSkippedStep(e){this.branchPath.skippedSteps.includes(e)||(this.branchPath.skippedSteps.push(e),b(`Step skipped: ${e}`,this.branchPath.skippedSteps))}setActiveCondition(e,t){this.branchPath.activeConditions[e]=t,b(`Active condition set: ${e}`,t)}getActiveCondition(e){return this.branchPath.activeConditions[e]}getFieldsByStep(e,t,i){const n={};return Object.entries(this.data).forEach(([e,t])=>{n[e]=t}),n}onFieldChange(e,t,i){t!==i&&b(`Field change detected: ${e}`,{from:i,to:t})}goToPreviousStep(){const e=this.branchPath.previousSteps.pop();return e?(this.branchPath.currentStep=e,b(`Went back to previous step: ${e}`,this.branchPath),e):null}wasStepVisited(e){return this.steps[e]?.visited||!1}isStepVisible(e){return this.steps[e]?.visible||!1}getDebugInfo(){return{data:this.data,steps:this.steps,branchPath:this.branchPath,fieldCount:Object.keys(this.data).length,stepCount:Object.keys(this.steps).length}}}const C=x.getInstance();let k=!1,T=[];function N(e=document){k&&(b("Branching already branchingInitialized, cleaning up first"),D()),b("Initializing branching logic");b(`Found ${v(d,e).length} branch triggers`);b(`Found ${v(a,e).length} conditional steps`),function(e){const t=w(e,"change",d,z),i=w(e,"input",d,z),n=w(e,"click",d,z),a=w(e,"click","label.radio_field, label.w-radio",V);T.push(t,i,n,a)}(e),k=!0,b("Branching initialization complete")}function V(e,t){console.log("[FormLib] Radio label clicked",{target:t,tagName:t.tagName,className:t.className});const i=t.querySelector('input[type="radio"][data-go-to]');if(!i){console.log("[FormLib] No radio input with data-go-to found in clicked label");const e=t.querySelector('input[type="radio"]');return void(e&&console.log("[FormLib] Found radio input without data-go-to",{radioInput:e,goTo:$(e,"data-go-to"),name:e.name,value:e.value,allAttributes:Array.from(e.attributes).map(e=>`${e.name}="${e.value}"`).join(" ")}))}const n=$(i,"data-go-to");console.log("[FormLib] Found radio input in label",{radioInput:i,goTo:n,name:i.name,value:i.value,allAttributes:Array.from(i.attributes).map(e=>`${e.name}="${e.value}"`).join(" ")}),i.checked=!0;const a=new Event("change",{bubbles:!0});Object.defineProperty(a,"target",{value:i}),console.log("[FormLib] Triggering branch logic for data-go-to:",n),z(a,i)}function z(e,t){if(console.log("[FormLib] handleBranchTrigger called",{target:t,tagName:t.tagName,type:t.type,isFormInput:E(t)}),!E(t))return void console.log("[FormLib] Target is not a form input, ignoring");const i=$(t,"data-go-to"),n=L(t);console.log("[FormLib] Branch trigger activated",{element:t,goTo:i,value:n,type:t.type||t.tagName,checked:t.checked,name:t.name,allAttributes:Array.from(t.attributes).map(e=>`${e.name}="${e.value}"`).join(" ")});const a=t.name||$(t,"data-step-field-name");var s;a&&C.setField(a,n),t instanceof HTMLInputElement?"radio"===t.type&&t.checked?(!function(e){if(!e.name)return;b(`Handling radio group selection for: ${e.name}`,{selectedValue:e.value,selectedGoTo:$(e,"data-go-to")});document.querySelectorAll(`input[type="radio"][name="${e.name}"]`).forEach(t=>{const i=t,n=$(i,"data-go-to");i!==e&&n&&(b(`Deactivating radio option: ${n}`),q(n),n&&P(n))})}(t),_(i,t.value),i&&(b(`Triggering step_item visibility: ${s=i}`),import("./multiStep.js").then(({showStepItem:e})=>{e(s)}).catch(e=>{console.warn("[FormLib] Failed to show step_item:",e)}))):"checkbox"===t.type?t.checked?_(i,t.value):q(i):"radio"!==t.type&&"checkbox"!==t.type&&(n?_(i,n):q(i)):n?_(i,n):q(i);const r=C.getBranchPath().activeConditions;Object.values(r).some(e=>null!=e&&""!==e)&&B()}function P(e){b(`Hiding step_item: ${e}`),import("./multiStep.js").then(({hideStepItem:t})=>{t&&t(e)}).catch(t=>{b(`Manual step_item hiding for: ${e}`);document.querySelectorAll(`[data-answer="${e}"]`).forEach(e=>{const t=e;t.style.display="none",t.style.visibility="hidden",t.classList.add("hidden-step")})})}function _(e,t){e&&(b(`Activating branch: ${e}`,{value:t,valueType:typeof t,targetString:String(e)}),C.setActiveCondition(e,t),function(){const e=v(n),t=[],i=[];e.forEach(e=>{const n=$(e,"data-answer"),a=!n||C.isStepVisible(n);e.querySelectorAll("input, select, textarea").forEach(e=>{const n=e.name||$(e,"data-step-field-name");n&&(a?t.push(n):i.push(n))})});const a=i.filter(e=>!t.includes(e));a.length>0&&C.clearFields(a)}(),b("Active conditions after branch activation",{activeConditions:C.getBranchPath().activeConditions}))}function q(e){e&&(b(`Deactivating branch: ${e}`),C.setActiveCondition(e,null),function(e){const t=S(`[data-answer="${e}"]`);if(!t)return;const i=t.querySelectorAll("input, select, textarea"),n=[];i.forEach(e=>{const t=e.name||$(e,"data-step-field-name");t&&n.push(t)}),n.length>0&&(C.clearFields(n),b(`Cleared fields from branch ${e}`,n))}(e),B())}function B(){const e=v(a),t=C.getBranchPath().activeConditions;b("Updating step visibility",{activeConditions:t}),e.forEach(e=>{const i=$(e,"data-answer"),n=function(e,t){if(!e)return!0;for(const[i,n]of Object.entries(t))if(i===e&&null!=n&&""!==n)return!0;return!1}(i,t);i&&C.setStepInfo(i,{visible:n});const a=e;n?(a.style.display="",a.classList.remove("hidden-step"),b(`Step made visible: ${i}`)):(a.style.display="none",a.classList.add("hidden-step"),b(`Step hidden: ${i}`))})}function D(){b("Resetting branching logic"),T.forEach(e=>e()),T=[];const e=C.getBranchPath().activeConditions;Object.keys(e).forEach(e=>{C.setActiveCondition(e,null)});v(a).forEach(e=>{const t=e;t.style.display="none",t.classList.add("hidden-step")}),k=!1,b("Branching reset complete")}e.debugBranching=function(){const e=C.getBranchPath().activeConditions;b("=== DEBUG: Branching State ==="),b("Active Conditions:",e);const t=v(d);b("All Branch Triggers:"),t.forEach((e,t)=>{const i=$(e,"data-go-to");let n="",a=!1,s=e.tagName;if(E(e)){const t=L(e);n=Array.isArray(t)?t.join(", "):t,e instanceof HTMLInputElement&&(a=e.checked,s=e.type)}b(`Trigger ${t}:`,{element:e,goTo:i,value:n,checked:a,type:s})});const i=v(a);b("All Answer Steps:"),i.forEach((e,t)=>{b(`Answer Step ${t}:`,{element:e,dataAnswer:$(e,"data-answer"),visible:"none"!==e.style.display})}),b("=== END DEBUG ===")};let j=!1,M=[],O=[],R=[],H=0,G=null;function U(e=document){j&&(b("MultiStep already multiStepInitialized, cleaning up first"),b("Resetting multi-step navigation"),M.forEach(e=>e()),M=[],O.forEach((e,t)=>{te(t)}),O=[],H=0,j=!1,b("Multi-step reset complete")),b("Initializing multi-step navigation with step/step_item architecture");const t=v(n,e);b(`Found ${t.length} parent steps`),O=Array.from(t).map((e,t)=>{const i=e,n=$(e,"data-answer"),a=n||`step-${t}`,s={element:i,id:a,index:t,type:$(e,"data-step-type")||void 0,subtype:$(e,"data-step-subtype")||void 0,number:$(e,"data-step-number")||void 0,isStepItem:!1};return b(`Registering parent step ${t}`,{stepId:a,dataAnswer:n,type:s.type,element:i}),C.setStepInfo(a,{type:s.type,subtype:s.subtype,number:s.number,visible:0===t,visited:!1}),s}),R=[],O.forEach((e,t)=>{const i=e.element.querySelectorAll(".step-item");console.log(`[FormLib] Found ${i.length} step_items in parent step ${t} (${e.id})`),i.forEach((i,n)=>{const a=i,s=$(i,"data-answer"),r=$(i,"data-go-to");if(console.log(`[FormLib] Processing step_item ${n}:`,{dataAnswer:s,dataGoTo:r,parentStepId:e.id,parentStepIndex:t,element:a,allAttributes:Array.from(a.attributes).map(e=>`${e.name}="${e.value}"`).join(" ")}),!s)return void console.warn(`[FormLib] Step item ${n} in parent step ${t} missing required data-answer attribute`);const o={element:a,id:s,index:R.length,type:$(i,"data-step-type")||void 0,subtype:$(i,"data-step-subtype")||void 0,number:$(i,"data-step-number")||void 0,isStepItem:!0,parentStepIndex:t};console.log("[FormLib] Registered step_item:",{stepId:s,parentStepIndex:t,globalIndex:R.length,type:o.type,element:a}),C.setStepInfo(s,{type:o.type,subtype:o.subtype,number:o.number,visible:!1,visited:!1}),R.push(o)})}),O.forEach((e,t)=>{J(e.element,`parent step ${t}`)}),R.forEach((e,t)=>{J(e.element,`step_item ${t} (${e.id})`)}),function(e){const t=w(e,"click",s,X),i=w(e,"click",r,Y),n=w(e,"click",l,K),a=w(e,"click",o,Q);M.push(t,i,n,a)}(e),O.length>0&&ee(0),j=!0,b("Multi-step initialization complete",{parentStepCount:O.length,stepItemCount:R.length})}function J(e,t){e.style.display="none !important",e.style.visibility="hidden",e.style.opacity="0",e.style.height="0",e.style.overflow="hidden",e.style.position="absolute",e.style.left="-9999px",F(e,"hidden-step"),F(e,f),A(e,m),e.setAttribute("data-step-hidden","true"),console.log(`[FormLib] Forcibly hiding ${t}:`,{display:e.style.display,visibility:e.style.visibility,opacity:e.style.opacity,height:e.style.height,classes:e.className,dataAnswer:$(e,"data-answer")})}function W(e){console.log(`[FormLib] Attempting to show step_item: ${e}`),console.log("[FormLib] Available step_items:",R.map(e=>({id:e.id,dataAnswer:$(e.element,"data-answer"),element:e.element})));const t=R.find(t=>t.id===e);if(!t){console.warn(`[FormLib] Step item not found: ${e}`),console.log(`[FormLib] Looking for step_item with data-answer="${e}"`);const t=R.find(t=>$(t.element,"data-answer")===e);return t?(console.log(`[FormLib] Found step_item by data-answer: ${e}`,t),W(t.id)):void 0}if(!O[t.parentStepIndex])return void console.warn(`[FormLib] Parent step not found for step_item: ${e}`);b(`Showing step_item ${e} in parent step ${t.parentStepIndex}`),console.log(`[FormLib] Hiding all step_items in parent step ${t.parentStepIndex}`);const i=R.filter(e=>e.parentStepIndex===t.parentStepIndex);var n,a;console.log(`[FormLib] Found ${i.length} step_items to hide in parent step`),i.forEach(e=>{console.log(`[FormLib] Hiding step_item: ${e.id} (data-answer="${$(e.element,"data-answer")}")`),J(e.element,`step_item ${e.id}`),C.setStepVisibility(e.id,!1)}),console.log(`[FormLib] Now showing target step_item: ${e}`),n=t.element,a=`step_item ${e}`,n.style.display="",n.style.visibility="",n.style.opacity="",n.style.height="",n.style.overflow="",n.style.position="",n.style.left="",A(n,"hidden-step"),A(n,f),F(n,m),n.removeAttribute("data-step-hidden"),console.log(`[FormLib] Showing ${a}:`,{display:n.style.display,visibility:n.style.visibility,opacity:n.style.opacity,classes:n.className,dataAnswer:$(n,"data-answer")}),C.setStepVisibility(e,!0),G=e,console.log(`[FormLib] Successfully showed step_item: ${e}`,{currentStepItemId:G,visibleStepItems:i.filter(t=>t.id===e).length})}function P(e){b(`Attempting to hide step_item: ${e}`);const t=R.find(t=>t.id===e);t?(b(`Hiding step_item: ${e}`),J(t.element,`step_item ${e}`),C.setStepVisibility(e,!1),G===e&&(G=null),b(`Successfully hid step_item: ${e}`)):b(`Step item not found for hiding: ${e}`)}function X(e,t){e.preventDefault(),b("Next button clicked");const i=ne();if(!i)return;if(G){const e=R.find(e=>e.id===G);if(e&&!Z(e.element))return void b("Step item validation failed, staying on current step")}else if(!Z(i.element))return void b("Step validation failed, staying on current step");let n=null;if(G){const e=R.find(e=>e.id===G);e&&(n=$(e.element,"data-go-to"),b(`Step item ${G} has data-go-to: ${n}`))}n||(n=function(e){const t=C.getBranchPath().activeConditions;b("Evaluating next step",{currentStep:e,activeConditions:t});for(const[e,i]of Object.entries(t))if(null!=i&&""!==i)return b(`Next step determined by branch: ${e}`),e;return b("No active branch conditions, using sequential navigation"),null}(i.id),b(`Branching logic determined next step: ${n}`)),n?function(e){b(`Attempting to navigate to step: ${e}`);const t=ie(e);if(-1!==t)return b(`Found parent step: ${e} at index ${t}`),G=null,void ee(t);const i=R.find(t=>t.id===e);if(i)return b(`Found step_item: ${e} in parent step ${i.parentStepIndex}`),void(void 0!==i.parentStepIndex&&(ee(i.parentStepIndex),W(e)));console.warn(`[FormLib] Step not found: ${e}`),b("Step not found",{targetStepId:e,availableParentSteps:O.map(e=>e.id),availableStepItems:R.map(e=>e.id)})}(n):function(){const e=H+1;e<O.length?ee(e):b("Already at last step")}()}function Y(e,t){e.preventDefault(),b("Back button clicked"),function(){const e=C.goToPreviousStep();if(e){const t=ie(e);if(-1!==t)return void ee(t)}const t=H-1;t>=0?ee(t):b("Already at first step")}()}function K(e,t){e.preventDefault();const i=$(t,"data-skip");if(b("Skip button clicked",{skipTarget:i}),i){const e=ie(i);if(-1!==e){for(let t=H+1;t<e;t++)C.addSkippedStep(O[t].id);ee(e)}else b(`Skip target step not found: ${i}`)}}function Q(e,t){b("Submit button clicked");if(!function(){let e=!0;return O.forEach((t,i)=>{if(C.isStepVisible(t.id)){const i=t.element.querySelectorAll("[required]");for(const n of i){const i=n;i.value.trim()||(b(`Required field empty in step ${t.id}: ${i.name||"unnamed"}`),e=!1)}}}),e}())return e.preventDefault(),void b("Form validation failed, preventing submission");b("Form validation passed, allowing submission")}function Z(e){const t=e.querySelectorAll("input[required], select[required], textarea[required]");for(const e of t){const t=e;if(I(t)){if(!t.value||""===t.value.trim())return b("Validation failed: empty required field",{element:t,name:t.name,id:t.id}),t.focus(),!1;if("email"===t.type&&t.value){if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t.value))return b("Validation failed: invalid email format",{element:t,value:t.value}),t.focus(),!1}}}return!0}function ee(e){if(e<0||e>=O.length)return void b(`Invalid step index: ${e}`);const t=H,i=O[e];b(`Navigating to step ${e}`,{from:t,to:e,stepId:i.id}),O[H]&&te(H),H=e,function(e){if(e<0||e>=O.length)return;const t=O[e],i=t.element;i.style.display="",i.style.visibility="",A(i,"hidden-step"),F(i,m),i.removeAttribute("data-step-hidden"),C.setStepInfo(t.id,{visible:!0,visited:!0});const n=R.filter(t=>t.parentStepIndex===e);n.forEach(e=>{J(e.element,`step_item ${e.id} (keeping hidden on parent step show)`),C.setStepVisibility(e.id,!1)}),b(`Step shown: ${t.id} (index: ${e})`,{display:i.style.display,visibility:i.style.visibility,classes:i.className,stepItemsHidden:n.length})}(e),C.setCurrentStep(i.id),function(){const e=v(r),t=v(s),i=v(o);e.forEach(e=>{const t=e;0===H?(t.disabled=!0,F(e,y)):(t.disabled=!1,A(e,y))});const n=H===O.length-1;t.forEach(e=>{const t=e;n?t.style.display="none":(t.style.display="",t.disabled=!1,A(e,y))}),i.forEach(e=>{const t=e;n?(t.style.display="",t.disabled=!1,A(e,y)):t.style.display="none"}),b("Navigation buttons updated",{currentStepIndex:H,isLastStep:n,backButtonsCount:e.length,nextButtonsCount:t.length,submitButtonsCount:i.length})}(),b("Step navigation complete",{currentStep:i.id,currentIndex:e})}function te(e){if(e<0||e>=O.length)return;const t=O[e],i=t.element;i.style.display="none",i.style.visibility="hidden",F(i,"hidden-step"),A(i,m),i.setAttribute("data-step-hidden","true"),C.setStepInfo(t.id,{visible:!1}),b(`Step hidden: ${t.id} (index: ${e})`,{display:i.style.display,visibility:i.style.visibility,classes:i.className})}function ie(e){return O.findIndex(t=>t.id===e)}function ne(){return O[H]||null}e.debugFormSteps=function(){b("=== DEBUG: All Registered Steps ==="),O.forEach((e,t)=>{const i=e.element;b(`Step ${t}:`,{stepId:e.id,dataAnswer:i.getAttribute("data-answer"),elementId:i.getAttribute("id"),index:e.index,visible:"none"!==i.style.display,classes:i.className,element:i})}),b("=== END DEBUG ===")};let ae=!1,se=[],re=new Map;function oe(e=document){ae&&(b("Validation already validationInitialized, cleaning up first"),b("Resetting validation"),se.forEach(e=>e()),se=[],b("Clearing all field validation"),re.forEach((e,t)=>{!function(e){const t=re.get(e);t&&(t.isValid=!0,t.errorMessage=void 0,ue(t.element,!0),b(`Cleared validation for field: ${e}`))}(t)}),re.clear(),ae=!1,b("Validation reset complete")),b("Initializing form validation");const t=v("input, select, textarea",e);b(`Found ${t.length} form inputs`),t.forEach(e=>{if(!E(e))return;const t=e.name||$(e,"data-step-field-name");if(!t)return;const i=function(e){const t=[];e.hasAttribute("required")&&t.push({type:"required",message:$(e,"data-error-message")||"This field is required"}),e instanceof HTMLInputElement&&"email"===e.type&&t.push({type:"email",message:"Please enter a valid email address"}),e instanceof HTMLInputElement&&"tel"===e.type&&t.push({type:"phone",message:"Please enter a valid phone number"});const i=$(e,"minlength");i&&t.push({type:"min",value:parseInt(i),message:`Minimum ${i} characters required`});const n=$(e,"maxlength");n&&t.push({type:"max",value:parseInt(n),message:`Maximum ${n} characters allowed`});const a=$(e,"pattern");return a&&t.push({type:"pattern",value:new RegExp(a),message:"Please enter a valid format"}),t}(e);0!==i.length&&(re.set(t,{element:e,rules:i,isValid:!0}),b(`Validation rules set for field: ${t}`,i))}),function(e){const t=function(e,t){let i;return(...n)=>{clearTimeout(i),i=setTimeout(()=>e(...n),t)}}(le,p.VALIDATION_DELAY),i=w(e,"input","input, select, textarea",t),n=w(e,"blur","input, select, textarea",le),a=w(e,"change","input, select, textarea",le);se.push(i,n,a)}(e),ae=!0,b("Validation initialization complete")}function le(e,t){if(!E(t))return;const i=t.name||$(t,"data-step-field-name");if(!i)return;const a=t.closest(n);if(a){const e=$(a,"data-answer");if(e&&!C.isStepVisible(e))return void b(`Skipping validation for field in hidden step: ${i}`)}de(i)}function de(e){const t=re.get(e);if(!t)return b(`No validation rules found for field: ${e}`),!0;const i=t.element,n=L(i);b(`Validating field: ${e}`,{value:n});let a=!0,s="";for(const e of t.rules){const t=ce(n,e);if(!t.isValid){a=!1,s=t.message||"Validation failed";break}}return t.isValid=a,t.errorMessage=s,ue(i,a,s),C.setField(e,n),b(`Field validation result: ${e}`,{isValid:a,errorMessage:s,value:n}),a}function ce(e,t){switch(t.type){case"required":return{isValid:!(""===e||null==e||Array.isArray(e)&&0===e.length),message:t.message};case"email":return{isValid:!e||/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(e)),message:t.message};case"phone":return{isValid:!e||/^[\+]?[1-9][\d]{0,15}$/.test(String(e).replace(/\D/g,"")),message:t.message};case"min":return{isValid:!e||String(e).length>=t.value,message:t.message};case"max":return{isValid:!e||String(e).length<=t.value,message:t.message};case"pattern":return{isValid:!e||t.value.test(String(e)),message:t.message};case"custom":return{isValid:!t.validator||t.validator(e),message:t.message};default:return{isValid:!0}}}function ue(e,t,i){t?A(e,h):F(e,h);const n=pe(e);n&&(t?(n.textContent="",n.style.display="none"):(n.textContent=i||"Validation failed",n.style.display="block"))}function pe(e){const t=e.name||$(e,"data-step-field-name");if(!t)return null;let i=e.parentElement?.querySelector(`.${g}[data-field="${t}"]`);return i||(i=document.createElement("div"),i.className=g,i.setAttribute("data-field",t),i.style.color="red",i.style.fontSize="0.875em",i.style.marginTop="0.25rem",i.style.display="none",e.parentElement?.insertBefore(i,e.nextSibling)),i}function me(){const e={validationInitialized:ae,totalFields:re.size,validFields:0,invalidFields:0,fields:{}};return re.forEach((t,i)=>{e.fields[i]={isValid:t.isValid,errorMessage:t.errorMessage,rulesCount:t.rules.length},t.isValid?e.validFields++:e.invalidFields++}),e}let fe=new Map;function he(){b("Clearing all field errors"),fe.forEach((e,t)=>{!function(e){const t=fe.get(e);t?(b(`Clearing error for field: ${e}`),A(t.element,h),t.errorElement&&(t.errorElement.textContent="",t.errorElement.style.display="none")):b(`Cannot clear error for unknown field: ${e}`)}(t)})}function ge(){const e=[];return fe.forEach((t,i)=>{(function(e){const t=fe.get(e);return!!t&&t.element.classList.contains(h)})(i)&&e.push(i)}),e}function pe(e){let t=e.element.parentElement?.querySelector(`.${g}[data-field="${e.fieldName}"]`);if(!t){t=document.createElement("div"),t.className=g,t.setAttribute("data-field",e.fieldName),t.style.color="red",t.style.fontSize="0.875em",t.style.marginTop="0.25rem",t.style.display="none";const i=e.element.parentElement;if(!i)return b(`Cannot create error element for field: ${e.fieldName} - no parent element`),null;{const n=e.element.nextSibling;n?i.insertBefore(t,n):i.appendChild(t)}b(`Created error element for field: ${e.fieldName}`)}return t}function ye(){const e=ge(),t={totalFields:fe.size,fieldsWithErrors:e.length,errors:{}};return e.forEach(e=>{const i=fe.get(e);t.errors[e]={message:i?.errorElement?.textContent||"Unknown error",customMessage:i?.customMessage}}),t}let be=!1,ve=[],Se=[];function $e(e=document){be&&(b("Summary already summaryInitialized, cleaning up first"),b("Resetting summary functionality"),ve.forEach(e=>e()),ve=[],Se.forEach(e=>{Le(e.element,"")}),Se=[],be=!1,b("Summary reset complete")),b("Initializing summary functionality");const t=v(u,e);b(`Found ${t.length} summary fields`),function(e){e.forEach(e=>{const t=$(e,"data-summary-field");if(!t)return;const i=t.split("|").map(e=>e.trim()),n=$(e,"data-join"),a=n&&n in p.JOIN_SEPARATOR?n:"space",s=$(e,"data-summary-type")||void 0,r=$(e,"data-summary-subtype")||void 0,o=$(e,"data-summary-number")||void 0,l={element:e,fieldNames:i,joinType:a,type:s,subtype:r,number:o};Se.push(l),b("Summary field configured",{fieldNames:i,joinType:a,type:s,subtype:r,number:o})})}(t),function(e){const t=w(e,"input",c,Fe),i=w(e,"change",c,Fe),n=w(e,"blur",c,Fe);ve.push(t,i,n)}(e),Ie(),be=!0,b("Summary initialization complete")}function Fe(e,t){if(!E(t))return;const i=$(t,"data-step-field-name");if(!i)return;const n=L(t);b(`Summary field changed: ${i}`,{value:n}),C.setField(i,n),Ae(i)}function Ae(e){Se.forEach(t=>{t.fieldNames.includes(e)&&Ee(t)})}function Ie(){Se.forEach(e=>{Ee(e)})}function Ee(e){const t=[];e.fieldNames.forEach(e=>{const i=C.getField(e);null!=i&&""!==i&&(Array.isArray(i)?t.push(...i.filter(e=>""!==e)):t.push(String(i)))});const i=function(e,t){if(0===e.length)return"";const i=p.JOIN_SEPARATOR[t];return e.join(i)}(t,e.joinType);Le(e.element,i),b("Summary field updated",{fieldNames:e.fieldNames,values:t,joinType:e.joinType,result:i})}function Le(e,t){e.textContent=t,""===t?(e.classList.add("summary-empty"),e.classList.remove("summary-filled")):(e.classList.remove("summary-empty"),e.classList.add("summary-filled"))}class we{constructor(){this.initialized=!1,this.rootElement=document,b("FormLibrary instance created")}static getInstance(){return we.instance||(we.instance=new we),we.instance}init(e=document){this.initialized&&(b("FormLibrary already initialized, reinitializing..."),this.destroy()),this.rootElement=e,b("Initializing FormLibrary",{root:e===document?"document":"custom element"});const a=e.querySelectorAll(t),s=e.querySelectorAll(i),r=e.querySelectorAll(n);if(b("Form detection results",{multistepForms:a.length,logicForms:s.length,stepElements:r.length}),0!==a.length||0!==r.length)try{!function(e=document){b("Initializing error handling"),e.querySelectorAll("input, select, textarea").forEach(e=>{const t=e.name||$(e,"data-step-field-name");t&&fe.set(t,{fieldName:t,element:e,customMessage:$(e,"data-error-message")||void 0})}),b(`Error handling errorsInitialized for ${fe.size} fields`)}(e),oe(e),s.length>0&&N(e),(a.length>0||r.length>0)&&U(e),$e(e),this.initialized=!0,b("FormLibrary initialization complete"),this.logCurrentState()}catch(e){throw b("FormLibrary initialization failed",e),e}else b("No compatible forms found, library will not initialize")}destroy(){if(this.initialized){b("Destroying FormLibrary");try{D()}catch(e){b("Error during FormLibrary destruction",e)}C.clear(),this.initialized=!1,b("FormLibrary destruction complete")}else b("FormLibrary not initialized, nothing to destroy")}isInitialized(){return this.initialized}getState(){return{initialized:this.initialized,formState:C.getDebugInfo(),branching:{branchingInitialized:k,activeConditions:C.getBranchPath().activeConditions,visibleSteps:Object.entries(C.getAllSteps()).filter(([e,t])=>t.visible).map(([e,t])=>e)},multiStep:{multiStepInitialized:j,currentStepIndex:H,totalSteps:O.length,steps:O.map(e=>({id:e.id,index:e.index,visible:I(e.element),type:e.type,subtype:e.subtype,number:e.number}))},validation:me(),errors:ye(),summary:{summaryInitialized:be,totalSummaryFields:Se.length,summaryFields:Se.map(e=>({fieldNames:e.fieldNames,joinType:e.joinType,type:e.type,subtype:e.subtype,number:e.number,currentValue:e.element.textContent||""})),formStateData:C.getAll()}}}logCurrentState(){b("Current FormLibrary State",this.getState())}validateForm(){if(!this.initialized)return b("Cannot validate form - library not initialized"),!1;b("Validating entire form");const e=function(){b("Validating all visible fields");let e=!0;const t={};for(const[i,a]of re){const s=a.element.closest(n);let r=!0;if(s){const e=$(s,"data-answer");e&&!C.isStepVisible(e)&&(r=!1)}if(r){const n=de(i);t[i]=n,n||(e=!1)}}return b("All visible fields validation complete",{allValid:e,results:t}),e}();return b("Form validation result",{isValid:e}),e}resetForm(){if(this.initialized){var e;b("Resetting form to initial state"),he(),C.clear(),e?(b("Clearing specific summary fields",e),C.clearFields(e),e.forEach(e=>{Ae(e)})):(b("Clearing all summaries"),C.clear(),Ie());try{ee(0)}catch(e){b("Could not go to first step during reset",e)}b("Form reset complete")}else b("Cannot reset form - library not initialized")}getFormData(){return C.getAll()}setFormData(e){Object.entries(e).forEach(([e,t])=>{C.setField(e,t)}),b("Updating all summaries"),Ie(),b("Form data set",e)}}const xe=we.getInstance();if(void 0!==e){const e=()=>{const e=document.querySelectorAll(t),i=document.querySelectorAll(n);(e.length>0||i.length>0)&&(b("Auto-initializing FormLibrary on DOM ready"),xe.init())};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e):e()}void 0!==e&&(e.FormLib=xe,b("FormLib attached to window for debugging")),void 0!==e&&(e.FormLibrary=we,e.FormLib=xe)}("undefined"!=typeof window?window:this);