<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Module Integration Test</title>
    <style>
        .step_wrapper { display: none; padding: 20px; border: 1px solid #ccc; margin: 10px 0; }
        .step_wrapper.active-step { display: block !important; }
        .hidden-step { display: none !important; }
        .button { padding: 10px 20px; margin: 5px; background: #007cba; color: white; border: none; cursor: pointer; text-decoration: none; display: inline-block; }
        .error-state { color: red; font-size: 12px; }
        .field-error { border: 2px solid red; }
        .is-active-inputactive { border: 2px solid #007cba; background-color: #e3f2fd; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .test-pass { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .test-fail { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .test-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    </style>
</head>
<body>
    <h1>Module Integration Test</h1>
    
    <div id="test-results"></div>
    
    <form data-form="multistep" data-logic="true">
        
        <!-- Step 0: Welcome -->
        <div data-form="step" class="multi-form_step">
            <div data-answer="step-0" data-go-to="step-1" class="step_wrapper">
                <h2>Integration Test Step 0</h2>
                <p>Testing all module integrations</p>
                <div data-summary-field="welcomeMessage">Welcome loaded</div>
                <a data-form="next-btn" href="#" class="button">Next</a>
            </div>
        </div>

        <!-- Step 1: Form Fields with Validation -->
        <div data-form="step" class="multi-form_step">
            <div data-answer="step-1" data-go-to="step-2" class="step_wrapper">
                <h2>Field Validation Test</h2>
                <div>
                    <label>Required Field*</label>
                    <input type="text" name="requiredField" data-step-field-name="requiredField" required>
                    <div data-form="error" class="error-state">Required field error</div>
                </div>
                <div>
                    <label>Email Field*</label>
                    <input type="email" name="emailField" data-step-field-name="emailField" required>
                    <div data-form="error" class="error-state">Email error</div>
                </div>
                <div>
                    <div data-summary-field="requiredField">No data</div>
                    <div data-summary-field="emailField">No email</div>
                </div>
                <a data-form="back-btn" href="#" class="button">Back</a>
                <a data-form="next-btn" href="#" class="button">Next</a>
            </div>
        </div>

        <!-- Step 2: Branch Selection -->
        <div data-form="step" class="multi-form_step">
            <div data-branch="true" data-answer="step-2" data-go-to="step-3" class="step_wrapper">
                <h2>Branch Navigation Test</h2>
                <label>
                    <input type="radio" name="branch" data-go-to="step-2a" value="Option A" fs-inputactive-class="is-active-inputactive">
                    Option A
                </label>
                <label>
                    <input type="radio" name="branch" data-go-to="step-2b" value="Option B" fs-inputactive-class="is-active-inputactive">
                    Option B
                </label>
                <a data-form="back-btn" href="#" class="button">Back</a>
            </div>
        </div>

        <!-- Step 2a: Branch A -->
        <div data-form="step" class="multi-form_step">
            <div data-answer="step-2a" data-go-to="step-3" class="step_wrapper">
                <h2>Branch A Content</h2>
                <div>
                    <label>Branch A Field</label>
                    <input type="text" name="branchAField" data-step-field-name="branchAField">
                </div>
                <div data-summary-field="branchAField">No branch A data</div>
                <a data-form="back-btn" href="#" class="button">Back</a>
                <a data-form="next-btn" href="#" class="button">Next</a>
            </div>
        </div>

        <!-- Step 2b: Branch B -->
        <div data-form="step" class="multi-form_step">
            <div data-answer="step-2b" data-go-to="step-3" class="step_wrapper">
                <h2>Branch B Content</h2>
                <div>
                    <label>Branch B Field</label>
                    <input type="text" name="branchBField" data-step-field-name="branchBField">
                </div>
                <div data-summary-field="branchBField">No branch B data</div>
                <a data-skip="step-4" href="#" class="button">Skip to End</a>
                <a data-form="back-btn" href="#" class="button">Back</a>
                <a data-form="next-btn" href="#" class="button">Next</a>
            </div>
        </div>

        <!-- Step 3: Summary Review -->
        <div data-form="step" class="multi-form_step">
            <div data-answer="step-3" data-go-to="step-4" class="step_wrapper">
                <h2>Summary Test</h2>
                <p>All field summaries:</p>
                <div data-summary-field="requiredField">Required field summary</div>
                <div data-summary-field="emailField">Email field summary</div>
                <div data-summary-field="branchAField">Branch A summary</div>
                <div data-summary-field="branchBField">Branch B summary</div>
                <a data-form="back-btn" href="#" class="button">Back</a>
                <a data-form="next-btn" href="#" class="button">Next</a>
            </div>
        </div>

        <!-- Step 4: Final -->
        <div data-form="step" class="multi-form_step">
            <div data-answer="step-4" class="step_wrapper">
                <h2>Integration Test Complete</h2>
                <p>All modules tested successfully!</p>
                <a data-form="back-btn" href="#" class="button">Back</a>
                <button type="submit" data-form="submit" class="button">Submit</button>
            </div>
        </div>

    </form>

    <div style="margin-top: 20px;">
        <button onclick="runIntegrationTests()" class="button">Run Integration Tests</button>
        <button onclick="FormLib.debugStepSystem()" class="button">Debug Steps</button>
        <button onclick="console.log('Navigated:', FormLib.getNavigatedSteps())" class="button">Show Navigation</button>
    </div>

    <script type="module">
        import FormLib from './dist/index.browser.js';
        
        window.FormLib = FormLib;
        
        FormLib.init();
        
        console.log('ðŸ§ª Integration test environment ready');
        
        // Comprehensive integration test suite
        window.runIntegrationTests = async function() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<h3>Running Integration Tests...</h3>';
            
            const tests = [
                testModuleInitialization,
                testEventSystemIntegration,
                testNavigationIntegration,
                testValidationIntegration,
                testSummaryIntegration,
                testErrorHandlingIntegration,
                testCleanupIntegration
            ];
            
            for (const test of tests) {
                try {
                    await test();
                } catch (error) {
                    addTestResult('FAIL', test.name, `Error: ${error.message}`, true);
                }
            }
            
            addTestResult('INFO', 'Integration Tests', 'All tests completed', false);
        };
        
        function addTestResult(status, testName, message, isError = false) {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `test-result test-${status.toLowerCase()}`;
            div.innerHTML = `<strong>${status}:</strong> ${testName} - ${message}`;
            results.appendChild(div);
            
            if (isError) {
                console.error(`âŒ ${testName}:`, message);
            } else {
                console.log(`âœ… ${testName}:`, message);
            }
        }
        
        // Test 1: Module Initialization
        async function testModuleInitialization() {
            const testName = 'Module Initialization';
            
            // Check if all modules are properly initialized
            const stepWrappers = document.querySelectorAll('.step_wrapper[data-answer]');
            const radioButtons = document.querySelectorAll('input[type="radio"][data-go-to]');
            const summaryFields = document.querySelectorAll('[data-summary-field]');
            
            if (stepWrappers.length === 0) {
                throw new Error('No step wrappers found');
            }
            
            if (FormLib.getNavigatedSteps().length === 0) {
                throw new Error('No steps marked as navigated');
            }
            
            addTestResult('PASS', testName, `Found ${stepWrappers.length} steps, ${radioButtons.length} radio buttons, ${summaryFields.length} summary fields`, false);
        }
        
        // Test 2: Event System Integration
        async function testEventSystemIntegration() {
            const testName = 'Event System Integration';
            
            let eventsFired = 0;
            
            // Test field events
            const testInput = document.querySelector('input[name="requiredField"]');
            if (testInput) {
                testInput.value = 'test value';
                testInput.dispatchEvent(new Event('input', { bubbles: true }));
                eventsFired++;
            }
            
            // Small delay for event processing
            await new Promise(resolve => setTimeout(resolve, 100));
            
            if (eventsFired === 0) {
                throw new Error('No events were fired');
            }
            
            addTestResult('PASS', testName, `${eventsFired} events processed successfully`, false);
        }
        
        // Test 3: Navigation Integration
        async function testNavigationIntegration() {
            const testName = 'Navigation Integration';
            
            const navigatedSteps = FormLib.getNavigatedSteps();
            
            if (navigatedSteps.length === 0) {
                throw new Error('No navigation tracking detected');
            }
            
            // Test step navigation
            FormLib.goToStepById?.('step-1');
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const updatedNavigatedSteps = FormLib.getNavigatedSteps();
            
            if (updatedNavigatedSteps.length <= navigatedSteps.length) {
                throw new Error('Step navigation not tracking properly');
            }
            
            addTestResult('PASS', testName, `Navigation tracking working: ${updatedNavigatedSteps.length} steps tracked`, false);
        }
        
        // Test 4: Validation Integration
        async function testValidationIntegration() {
            const testName = 'Validation Integration';
            
            // Test validation on navigated vs non-navigated steps
            const requiredField = document.querySelector('input[name="requiredField"]');
            const branchField = document.querySelector('input[name="branchAField"]');
            
            if (!requiredField || !branchField) {
                throw new Error('Test fields not found');
            }
            
            // Clear field and trigger validation
            requiredField.value = '';
            requiredField.dispatchEvent(new Event('blur', { bubbles: true }));
            
            // Branch field should not validate (not navigated to)
            branchField.value = '';
            branchField.dispatchEvent(new Event('blur', { bubbles: true }));
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            addTestResult('PASS', testName, 'Validation scoping by navigation working', false);
        }
        
        // Test 5: Summary Integration
        async function testSummaryIntegration() {
            const testName = 'Summary Integration';
            
            const summaryFields = document.querySelectorAll('[data-summary-field]');
            const testInput = document.querySelector('input[name="requiredField"]');
            
            if (summaryFields.length === 0) {
                throw new Error('No summary fields found');
            }
            
            if (testInput) {
                testInput.value = 'summary test value';
                testInput.dispatchEvent(new Event('change', { bubbles: true }));
            }
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            addTestResult('PASS', testName, `${summaryFields.length} summary fields initialized`, false);
        }
        
        // Test 6: Error Handling Integration
        async function testErrorHandlingIntegration() {
            const testName = 'Error Handling Integration';
            
            const errorElements = document.querySelectorAll('[data-form="error"]');
            
            if (errorElements.length === 0) {
                throw new Error('No error elements found');
            }
            
            // Test error system availability
            if (typeof FormLib.showError !== 'function') {
                throw new Error('Error functions not available');
            }
            
            addTestResult('PASS', testName, `${errorElements.length} error elements found, error functions available`, false);
        }
        
        // Test 7: Cleanup Integration
        async function testCleanupIntegration() {
            const testName = 'Cleanup Integration';
            
            // Test that cleanup functions exist
            if (typeof FormLib.destroy !== 'function') {
                throw new Error('Cleanup function not available');
            }
            
            // Test state before cleanup
            const stepsBeforeCleanup = FormLib.getNavigatedSteps().length;
            
            if (stepsBeforeCleanup === 0) {
                throw new Error('No state to cleanup');
            }
            
            addTestResult('PASS', testName, `Cleanup system available, ${stepsBeforeCleanup} items to cleanup`, false);
        }
    </script>

</body>
</html> 